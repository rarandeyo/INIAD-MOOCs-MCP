# INIAD MOOCs 課題提出・操作プロンプトテンプレート

## 目的

INIAD MOOCs 上の特定の操作（講義資料の閲覧、課題/練習問題の確認・提出など）を実行する。

## 前提条件

- 操作に必要な情報（コース名、講義名、課題/練習問題名、提出内容、ファイルパスなど）が提供されていること。

## 重要な注意事項

- **ダイアログ処理**: 操作中（特に課題提出時）にconfirmationダイアログやalertが表示される場合があります。ダイアログが表示された場合は、`browser_handle_dialog` ツールを使用して適切に対応してください。
- **エラーハンドリング**: 各ステップで予期しない状況（ページ読み込みエラー、要素が見つからない等）が発生した場合は、適切な診断とリトライを行ってください。

## 基本的な処理フロー

1.  **目標の明確化**: ユーザーの指示から、最終的な目標（例: 「プログラミング 1 第 3 回 練習問題」にファイル `kadai3.ipynb` を提出する）を特定する。

2.  **現在地の確認と移動 (Navigate & List)**:

    - **URL が指定されている場合**: `browser_navigate` で直接その URL に移動する。
      - 移動後、ログインページにリダイレクトされた場合は、ステップ 3 に進む。
      - 移動後のページに応じて、`navigate` が自動的にリスト（コース、講義、スライド）を取得する場合がある。結果を確認する。
    - **URL が指定されていない場合**:
      - まず `https://moocs.iniad.org/courses` に `browser_navigate` で移動する。
      - `navigate` の結果に含まれるコースリストから、目的のコース名を探し、その URL を特定する。
      - 特定したコース URL に `browser_navigate` で移動する。
      - `navigate` の結果に含まれる講義リストから、目的の講義名や課題/練習問題名を探し、その URL を特定する。
      - 特定した講義、課題/練習問題 URL に `browser_navigate` で移動する。（最終目的地）
      - （必要に応じて）移動後の `navigate` の結果に含まれるスライドリストから、目的のスライド URL を特定し、さらに `browser_navigate` で移動する。
    - **移動失敗時の対応**: いずれかの `navigate` が失敗し、ログインページらしき場所に遷移した場合（URL やスナップショットで判断）、ステップ 3 に進む。

3.  **ログイン処理 (Login)**:

    - ログインが必要と判断された場合（ステップ 2 でログインページに遷移した場合など）、`loginToIniadMoocsWithIniadAccount` を実行する。
    - ログイン成功後、本来の目的地の URL（ステップ 2 で目指していた URL）へ再度 `browser_navigate` を試みる。

4.  **課題/練習問題内容の確認 (Snapshot)**:

    - ユーザーから提出内容（テキスト、ファイルパスなど）が**指定されていない**場合、または課題/練習問題の詳細を確認する必要がある場合：
      - まず、直前の `browser_navigate` で取得されたスナップショットが存在するか確認する。
      - スナップショットが存在し、内容が最新であると判断できる場合は、それを分析する。
      - スナップショットが存在しない、古い、またはページが動的に変化した可能性がある場合は、`browser_snapshot` を実行して最新のスナップショットを取得し、それを分析する。
      - 取得・分析したスナップショットの内容から、課題/練習問題の指示（入力フィールド、必要なファイル、提出ボタンなど）を確認する。
      - 確認結果をユーザーに提示し、提出内容の指示を仰ぐか、可能であれば内容を推測して次のステップに進む。

5.  **課題/練習問題提出処理 (Submit Assignment)**:
    - 提出内容と提出先の要素（入力フィールドの ref、提出ボタンの ref など）が確定している場合：
      - **ノートブックのセル実行結果の確認と再実行**:
        - 提出する `.ipynb` ファイルについて、各セルの実行結果が存在するか確認する。
        - いずれかのセルに実行結果が存在しない場合、ノートブック内のすべてのセルを再実行する。
      - **課題内容との整合性確認と修正**:
        - 課題内容（スナップショットから取得した問題文、要求事項など）と現在のノートブックの内容の整合性を確認する。
        - 整合性が取れていない場合（例：必要な処理が実装されていない、変数の値が異なる、変数名が異なる、出力形式が違うなど）：
          - 課題の要求事項に合わせてノートブックのコードを修正する。
          - 修正後、すべてのセルを再実行して、期待される出力が得られることを確認する。
      - **HTML ファイルの準備**:
        - 提出フォームに `.html` ファイルが必要な場合（スナップショット等で確認）：
          - 提出する `.ipynb` ファイルと同じディレクトリに、対応する `.html` ファイル（例: `kadai3.ipynb` に対する `kadai3.html`）が存在するか確認する。
          - 存在する場合は、その `.html` ファイルをアップロード対象とする。
          - 存在しない場合は、適切なコマンド（例: `jupyter nbconvert --to html kadai3.ipynb`）を実行して `.html` ファイルを生成し、それをアップロード対象とする。関連するツール（`run_in_terminal`など）を使用してコマンドを実行する。
      - 直前の `navigate`で取得された**最新のスナップショット**に基づいて、`submit_assignment` ツールに必要なパラメータ（`operations` 配列と `submitButtonRef`）を組み立てる。`navigate` で取得した snapshot を利用した処理が失敗した場合のみ、`browser_snapshot` を実行して最新のスナップショットを取得する。
        - `operations` には、テキスト入力 (`type`)、ファイルアップロード (`upload`) などの操作を、スナップショットから得られた `ref` と共に指定する。ファイルアップロードの場合、準備したファイルパス（`.ipynb` または生成/確認した `.html`）を使用する。
      - `submit_assignment` を実行する。
      - **ダイアログ処理**:
        - `submit_assignment`で帰って来るダイアログの結果よって提出が成功したのか、失敗したのかを判断する。

6.  **他の未提出課題/練習問題の確認 (任意)**:

    - 提出処理後、現在のコースの講義一覧ページに `browser_navigate` で移動する（既にいる場合は不要）。
    - `navigate` の結果に含まれる講義リストとスナップショット（または必要なら `browser_snapshot` で最新化）を確認する。
    - スナップショットから各課題/練習問題の提出状況（例: "提出済み"、"未提出"、特定のアイコンなど）を識別する。
    - 今回提出したもの以外に未提出の課題/練習問題があれば、そのリストを作成する。

7.  **完了報告**:
    - 全ての操作が完了したら、最終的な結果（例: 課題/練習問題の提出完了、指定ページの表示完了など）をユーザーに報告する。
    - ステップ 6 で未提出の課題/練習問題リストが作成された場合は、その情報も併せて報告する。（例: 「提出が完了しました。なお、このコースには他に以下の未提出課題があります: [課題名 1, 課題名 2]」）